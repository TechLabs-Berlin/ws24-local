{"version":3,"names":["composeDeclarations","filters","composer","length","reverse","reduce","inner","outer","Declaration","constructor","index","indexes","save","push","decls","restore","pop","decl","popAll","splice","popAllAsOne","Error","DeclarationContext","Skia","peComp","PathEffect","MakeCompose","bind","ifComp","ImageFilter","cfComp","ColorFilter","paints","maskFilters","shaders","pathEffects","imageFilters","colorFilters"],"sources":["DeclarationContext.ts"],"sourcesContent":["import type {\n  SkShader,\n  SkPaint,\n  SkImageFilter,\n  SkMaskFilter,\n  SkPathEffect,\n  Skia,\n  SkColorFilter,\n} from \"../../skia/types\";\n\ntype Composer<T> = (outer: T, inner: T) => T;\n\nexport const composeDeclarations = <T>(filters: T[], composer: Composer<T>) => {\n  if (filters.length <= 1) {\n    return filters[0];\n  }\n  return filters.reverse().reduce((inner, outer) => {\n    if (!inner) {\n      return outer;\n    }\n    return composer(outer, inner);\n  });\n};\n\nclass Declaration<T> {\n  private decls: T[] = [];\n  private indexes = [0];\n\n  constructor(private composer?: Composer<T>) {}\n\n  private get index() {\n    return this.indexes[this.indexes.length - 1];\n  }\n\n  save() {\n    this.indexes.push(this.decls.length);\n  }\n\n  restore() {\n    this.indexes.pop();\n  }\n\n  pop() {\n    return this.decls.pop();\n  }\n\n  push(decl: T) {\n    this.decls.push(decl);\n  }\n\n  popAll() {\n    return this.decls.splice(this.index, this.decls.length - this.index);\n  }\n\n  popAllAsOne() {\n    if (!this.composer) {\n      throw new Error(\"No composer for this type of declaration\");\n    }\n    const decls = this.popAll();\n    return composeDeclarations(decls, this.composer!);\n  }\n}\n\nexport class DeclarationContext {\n  readonly paints: Declaration<SkPaint>;\n  readonly maskFilters: Declaration<SkMaskFilter>;\n  readonly shaders: Declaration<SkShader>;\n  readonly pathEffects: Declaration<SkPathEffect>;\n  readonly imageFilters: Declaration<SkImageFilter>;\n  readonly colorFilters: Declaration<SkColorFilter>;\n\n  constructor(private Skia: Skia) {\n    const peComp = this.Skia.PathEffect.MakeCompose.bind(this.Skia.PathEffect);\n    const ifComp = this.Skia.ImageFilter.MakeCompose.bind(\n      this.Skia.ImageFilter\n    );\n    const cfComp = this.Skia.ColorFilter.MakeCompose.bind(\n      this.Skia.ColorFilter\n    );\n    this.paints = new Declaration<SkPaint>();\n    this.maskFilters = new Declaration<SkMaskFilter>();\n    this.shaders = new Declaration<SkShader>();\n    this.pathEffects = new Declaration<SkPathEffect>(peComp);\n    this.imageFilters = new Declaration<SkImageFilter>(ifComp);\n    this.colorFilters = new Declaration<SkColorFilter>(cfComp);\n  }\n\n  save() {\n    this.paints.save();\n    this.maskFilters.save();\n    this.shaders.save();\n    this.pathEffects.save();\n    this.imageFilters.save();\n    this.colorFilters.save();\n  }\n\n  restore() {\n    this.paints.restore();\n    this.maskFilters.restore();\n    this.shaders.restore();\n    this.pathEffects.restore();\n    this.imageFilters.restore();\n    this.colorFilters.restore();\n  }\n}\n"],"mappings":"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"}