{"version":3,"names":["ClipOp","isRRect","isPathDef","processPath","processTransformProps","JsiNode","JsiDeclarationNode","paintProps","JsiRenderNode","constructor","ctx","type","props","matrix","Skia","Matrix","onPropChange","setProps","setProp","key","value","hasChanged","includes","paintCache","identity","clipPath","undefined","clipRect","clipRRect","computeMatrix","computeClip","addChild","child","setInvalidate","insertChildBefore","before","clip","render","invertClip","layer","transform","canvas","parentPaint","paint","cache","parent","shouldRestore","saveAndConcat","hasTransform","hasClip","shouldSave","op","Difference","Intersect","saveLayer","save","concat","renderNode","restore"],"sources":["RenderNode.ts"],"sourcesContent":["import type {\n  SkMatrix,\n  SkRect,\n  SkRRect,\n  SkPath,\n  SkPaint,\n} from \"../../skia/types\";\nimport { ClipOp, isRRect } from \"../../skia/types\";\nimport type {\n  RenderNode,\n  GroupProps,\n  NodeType,\n  Node,\n  DrawingContext,\n} from \"../types\";\n\nimport { isPathDef, processPath, processTransformProps } from \"./datatypes\";\nimport type { NodeContext } from \"./Node\";\nimport { JsiNode, JsiDeclarationNode } from \"./Node\";\n\nconst paintProps = [\n  \"color\",\n  \"strokeWidth\",\n  \"blendMode\",\n  \"strokeCap\",\n  \"strokeJoin\",\n  \"strokeMiter\",\n  \"style\",\n  \"antiAlias\",\n  \"opacity\",\n];\n\ninterface PaintCache {\n  parent: SkPaint;\n  child: SkPaint;\n}\n\nexport abstract class JsiRenderNode<P extends GroupProps>\n  extends JsiNode<P>\n  implements RenderNode<P>\n{\n  paintCache: PaintCache | null = null;\n\n  matrix: SkMatrix;\n  clipRect?: SkRect;\n  clipRRect?: SkRRect;\n  clipPath?: SkPath;\n\n  constructor(ctx: NodeContext, type: NodeType, props: P) {\n    super(ctx, type, props);\n    this.matrix = this.Skia.Matrix();\n    this.onPropChange();\n  }\n\n  setProps(props: P) {\n    super.setProps(props);\n    this.onPropChange();\n  }\n\n  setProp<K extends keyof P>(key: K, value: P[K]) {\n    const hasChanged = super.setProp(key, value);\n    if (hasChanged) {\n      this.onPropChange();\n      if (paintProps.includes(key as string)) {\n        this.paintCache = null;\n      }\n    }\n    return hasChanged;\n  }\n\n  protected onPropChange() {\n    this.matrix.identity();\n    this.clipPath = undefined;\n    this.clipRect = undefined;\n    this.clipRRect = undefined;\n    this.computeMatrix();\n    this.computeClip();\n  }\n\n  addChild(child: Node<unknown>) {\n    if (child instanceof JsiDeclarationNode) {\n      child.setInvalidate(() => {\n        this.paintCache = null;\n      });\n    }\n    super.addChild(child);\n  }\n\n  insertChildBefore(child: Node<unknown>, before: Node<unknown>) {\n    if (child instanceof JsiDeclarationNode) {\n      child.setInvalidate(() => {\n        this.paintCache = null;\n      });\n    }\n    super.insertChildBefore(child, before);\n  }\n\n  private computeClip() {\n    const { clip } = this.props;\n    if (clip) {\n      if (isPathDef(clip)) {\n        this.clipPath = processPath(this.Skia, clip);\n      } else if (isRRect(clip)) {\n        this.clipRRect = clip;\n      } else {\n        this.clipRect = clip;\n      }\n    }\n  }\n\n  private computeMatrix() {\n    processTransformProps(this.matrix, this.props);\n  }\n\n  render(ctx: DrawingContext) {\n    const { invertClip, layer, matrix, transform } = this.props;\n    const { canvas } = ctx;\n    const parentPaint = ctx.paint;\n\n    const cache =\n      this.paintCache !== null && this.paintCache.parent === ctx.paint\n        ? this.paintCache.child\n        : undefined;\n    const shouldRestore = ctx.saveAndConcat(this, cache);\n\n    const hasTransform = matrix !== undefined || transform !== undefined;\n    const hasClip =\n      this.clipRect !== undefined ||\n      this.clipPath !== undefined ||\n      this.clipRRect !== undefined;\n    const shouldSave = hasTransform || hasClip || !!layer;\n    const op = invertClip ? ClipOp.Difference : ClipOp.Intersect;\n    if (shouldSave) {\n      if (layer) {\n        if (typeof layer === \"boolean\") {\n          canvas.saveLayer();\n        } else {\n          canvas.saveLayer(layer);\n        }\n      } else {\n        canvas.save();\n      }\n    }\n\n    if (this.matrix) {\n      canvas.concat(this.matrix);\n    }\n    if (this.clipRect) {\n      canvas.clipRect(this.clipRect, op, true);\n    } else if (this.clipRRect) {\n      canvas.clipRRect(this.clipRRect, op, true);\n    } else if (this.clipPath) {\n      canvas.clipPath(this.clipPath, op, true);\n    }\n\n    this.renderNode(ctx);\n\n    if (shouldSave) {\n      canvas.restore();\n    }\n    if (shouldRestore) {\n      this.paintCache = {\n        parent: parentPaint,\n        child: ctx.paint,\n      };\n      ctx.restore();\n    }\n  }\n\n  abstract renderNode(ctx: DrawingContext): void;\n}\n"],"mappings":"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"}